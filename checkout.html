<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ - SolarGroup</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
            <!-- Web Component Header -->
    <sg-header></sg-header>

    <div class="app-layout">
                        <!-- Web Component Sidebar -->
        <sg-sidebar></sg-sidebar>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 id="package-title">–ü–∞–∫–µ—Ç 500 $</h1>
                <div class="package-stage-badge" id="package-stage">20 —ç—Ç–∞–ø            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>

            <div class="checkout-container">
                <div class="checkout-main">
                    <!-- Package Details -->
                    <div class="package-details-card">
                        <h3>–î–µ—Ç–∞–ª–∏ –ø–∞–∫–µ—Ç–∞</h3>
                        
                        <!-- Desktop detailed view -->
                        <div class="package-details-desktop">
                        <div class="package-summary" id="package-summary">
                            <!-- Package details will be loaded here -->
                            </div>
                            
                            <div class="package-info-compact">
                                <div class="info-row">
                                    <span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–µ–π:</span>
                                    <span class="info-value">15 000</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ë–æ–Ω—É—Å–Ω—ã–µ –¥–æ–ª–∏:</span>
                                    <span class="info-value bonus-shares">
                                        +250
                                        <span class="bonus-icon">üéÅ</span>
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–¶–µ–Ω–∞ –∑–∞ –¥–æ–ª—é:</span>
                                    <span class="info-value">~0,03333 $</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–î–∏—Å–∫–æ–Ω—Ç:</span>
                                    <span class="info-value">~30</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–†–∞—Å—Å—Ä–æ—á–∫–∞:</span>
                                    <span class="info-value">10 –º–µ—Å.</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ù–æ–º–∏–Ω–∞–ª:</span>
                                    <span class="info-value">15 000 $</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ü–ª–∞—Ç—ë–∂:</span>
                                    <span class="info-value">50 $</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile simplified view -->
                        <div class="package-details-mobile">
                            <div class="mobile-package-summary" id="mobile-package-summary">
                                <!-- Mobile package summary will be loaded here -->
                            </div>
                            
                            <div class="package-info-compact">
                                <div class="info-row">
                                    <span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–µ–π:</span>
                                    <span class="info-value">15 000</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ë–æ–Ω—É—Å–Ω—ã–µ –¥–æ–ª–∏:</span>
                                    <span class="info-value bonus-shares">
                                        +250
                                        <span class="bonus-icon">üéÅ</span>
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–¶–µ–Ω–∞ –∑–∞ –¥–æ–ª—é:</span>
                                    <span class="info-value">~0,03333 $</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–î–∏—Å–∫–æ–Ω—Ç:</span>
                                    <span class="info-value">~30</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–†–∞—Å—Å—Ä–æ—á–∫–∞:</span>
                                    <span class="info-value">10 –º–µ—Å.</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ù–æ–º–∏–Ω–∞–ª:</span>
                                    <span class="info-value">15 000 $</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ü–ª–∞—Ç—ë–∂:</span>
                                    <span class="info-value">50 $</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Schedule -->
                    <div class="schedule-header" id="toggle-schedule">
                            <h3>–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                        <div class="chevron-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                        </div>
                    </div>
                    <div class="payment-schedule-content" id="payment-schedule-content" style="display: none;">
                        <!-- Payment schedule will be generated here -->
                    </div>
                    


                    <!-- Bonus Banner -->
                    <div class="bonus-banner" id="bonus-banner" style="display: none;">
                        <div class="bonus-icon">üéÅ            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                        <div class="bonus-content">
                            <h4>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–π –±–æ–Ω—É—Å</h4>
                            <div class="bonus-details">
                                <span class="bonus-amount" id="bonus-amount">750 –¥–æ–ª–µ–π</span>
                                <span class="bonus-percentage" id="bonus-percentage">+5%</span>
                                <a href="#" class="bonus-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                            </div>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                    </div>
                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                </div>

                <div class="checkout-sidebar">
                    <div class="checkout-card">
                        <h3>–û–ø–ª–∞—Ç–∞ –ø–∞–∫–µ—Ç–∞</h3>
                        
                        <!-- Account Selection -->
                        <div class="account-selector">
                            <div class="account-options">
                                <div class="account-option selected" data-account="main">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="main" checked>
                                        <span class="radio-custom"></span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–û—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç</div>
                                        <div class="account-balance main-balance-amount">–ë–∞–ª–∞–Ω—Å 0,00 $</div>
                                    </div>
                                </div>
                                
                                <div class="account-option" data-account="partner">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="partner">
                                        <span class="radio-custom"></span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π —Å—á—ë—Ç</div>
                                        <div class="account-balance partner-balance-amount">–ë–∞–ª–∞–Ω—Å 0,00 $</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Double Payment Switch -->
                        <div class="payment-options">
                            <div class="double-payment-switch">
                                <div class="switch-label">+250</div>
                                <label class="switch">
                                    <input type="checkbox" id="double-payment-switch">
                                    <span class="slider"></span>
                                </label>
                                <div class="switch-text">–î–≤–æ–π–Ω–æ–π –ø–ª–∞—Ç—ë–∂</div>
                            </div>
                        </div>

                        <!-- Coupon Section -->
                        <div class="coupon-section">
                            <!-- Design Variants Selector -->
                            <div class="design-variants">
                                <h4>–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–∏–∑–∞–π–Ω–∞ –±–∞–Ω–Ω–µ—Ä–∞:</h4>
                                <div class="variant-buttons">
                                    <button class="variant-btn active" data-variant="minimal">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</button>
                                    <button class="variant-btn" data-variant="gradient">–ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π</button>
                                    <button class="variant-btn" data-variant="card">–ö–∞—Ä—Ç–æ—á–Ω—ã–π</button>
                                    <button class="variant-btn" data-variant="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                                    <button class="variant-btn" data-variant="banner">–ë–∞–Ω–Ω–µ—Ä</button>
                                    <button class="variant-btn" data-variant="coupon">–ö—É–ø–æ–Ω</button>
                                </div>
                            </div>
                            
                            <!-- Coupon Banner Variants -->
                            <!-- 1. Minimalist -->
                            <div class="coupon-banner coupon-banner-minimal" id="coupon-banner-minimal" style="display: none;">
                                <div class="coupon-banner-content">
                                    <div class="coupon-banner-icon">üéüÔ∏è</div>
                                    <div class="coupon-banner-info">
                                        <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                        <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                        <div class="coupon-banner-details">
                                            <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                            <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                            <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                        </div>
                                    </div>
                                    <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            
                            <!-- 2. Gradient -->
                            <div class="coupon-banner coupon-banner-gradient" id="coupon-banner-gradient" style="display: none;">
                                <div class="coupon-banner-content">
                                    <div class="coupon-banner-icon">üéüÔ∏è</div>
                                    <div class="coupon-banner-info">
                                        <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                        <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                        <div class="coupon-banner-details">
                                            <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                            <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                            <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                        </div>
                                    </div>
                                    <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            
                            <!-- 3. Card -->
                            <div class="coupon-banner coupon-banner-card" id="coupon-banner-card" style="display: none;">
                                <div class="coupon-banner-content">
                                    <div class="coupon-banner-icon">üéüÔ∏è</div>
                                    <div class="coupon-banner-info">
                                        <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                        <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                        <div class="coupon-banner-details">
                                            <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                            <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                            <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                        </div>
                                    </div>
                                    <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            
                            <!-- 4. Notification -->
                            <div class="coupon-banner coupon-banner-notification" id="coupon-banner-notification" style="display: none;">
                                <div class="coupon-banner-content">
                                    <div class="coupon-banner-icon">üéüÔ∏è</div>
                                    <div class="coupon-banner-info">
                                        <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                        <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                        <div class="coupon-banner-details">
                                            <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                            <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                            <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                        </div>
                                    </div>
                                    <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            
                            <!-- 5. Banner -->
                            <div class="coupon-banner coupon-banner-banner" id="coupon-banner-banner" style="display: none;">
                                <div class="coupon-banner-content">
                                    <div class="coupon-banner-icon">üéüÔ∏è</div>
                                    <div class="coupon-banner-info">
                                        <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                        <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                        <div class="coupon-banner-details">
                                            <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                            <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                            <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                        </div>
                                    </div>
                                    <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>

                            <!-- 6. Real Coupon -->
                            <div class="coupon-banner coupon-banner-coupon" id="coupon-banner-coupon" style="display: none;">
                                <div class="coupon-ticket">
                                    <div class="coupon-left">
                                        <div class="coupon-discount-large">-25$</div>
                                        <div class="coupon-description">–°–∫–∏–¥–∫–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç</div>
                                    </div>
                                    <div class="coupon-divider"></div>
                                    <div class="coupon-right">
                                        <button class="coupon-apply-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                        </div>

                            <!-- Coupon Input -->
                            <div class="coupon-input-section">
                                <label for="coupon-input" class="coupon-label">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –∫—É–ø–æ–Ω</label>
                                <div class="coupon-input-container">
                                    <input type="text" id="coupon-input" class="coupon-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫—É–ø–æ–Ω–∞">
                                    <button class="btn btn--secondary" id="validate-coupon-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        </div>
                                <div class="coupon-feedback" id="coupon-feedback"></div>
                        </div>
                        </div>
                        
                        <!-- Checkout Button -->
                        <button class="btn btn--primary btn--full" id="checkout-btn">
                            –û—Ñ–æ—Ä–º–∏—Ç—å –ø–∞–∫–µ—Ç
                        </button>
                    </div>
                </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>

            <!-- Success Notification -->
            <div class="notification hidden" id="success-notification">
                <div class="notification-content">
                    <span id="notification-text">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</span>
                    <button class="notification-close">&times;</button>
                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>
        </main>
                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
    </div>

        
            <script src="components/web-components/header-standalone.js"></script>
    <script src="components/web-components/sidebar-standalone.js"></script>
    <script src="app.js"></script>
    
    <script src="checkout.js"></script>
    <script>
        // Checkout Coupons Logic
        console.log('Checkout coupons script loaded');

        class CheckoutCoupons {
            constructor() {
                console.log('CheckoutCoupons constructor called');
                this.userId = 1; // Demo user ID
                this.availableCoupons = [];
                this.appliedCoupon = null;
                this.packageAmount = 0;
                this.userBalance = 0;
                
                this.init();
            }
            
            init() {
                this.loadAvailableCoupons();
                this.loadUserBalance();
                this.bindEvents();
                this.updatePackageAmount();
            }
            
            async loadAvailableCoupons() {
                try {
                    const response = await fetch(`/api/coupons/active/${this.userId}`);
                    const coupons = await response.json();
                    
                    this.availableCoupons = coupons;
                    this.checkForRelevantCoupons();
                } catch (error) {
                    console.error('Error loading coupons:', error);
                }
            }
            
            async loadUserBalance() {
                try {
                    console.log('Loading user balance for userId:', this.userId);
                    const response = await fetch(`/api/wallet/${this.userId}`);
                    console.log('Balance API response status:', response.status);
                    
                    const balanceData = await response.json();
                    console.log('Balance API response data:', balanceData);
                    
                    this.userBalance = balanceData.main_balance || 0;
                    console.log('User balance set to:', this.userBalance);
                    
                    this.updateCheckoutButton();
                } catch (error) {
                    console.error('Error loading user balance:', error);
                    this.userBalance = 0;
                    console.log('User balance set to 0 due to error');
                    this.updateCheckoutButton();
                }
            }
            
            checkForRelevantCoupons() {
                console.log('Checking for relevant coupons...');
                console.log('Available coupons:', this.availableCoupons);
                
                // Check for general coupons (not tied to specific projects)
                const generalCoupons = this.availableCoupons.filter(coupon => 
                    !coupon.project_name || coupon.project_name === '–õ—é–±–æ–π'
                );
                
                console.log('General coupons found:', generalCoupons);
                
                if (generalCoupons.length > 0) {
                    this.showCouponBanner(generalCoupons[0]);
                } else {
                    console.log('No general coupons found');
                }
            }
            
            showCouponBanner(coupon) {
                console.log('showCouponBanner called with coupon:', coupon);
                const banner = document.getElementById('coupon-banner');
                const codeElement = document.getElementById('coupon-banner-code');
                const discountElement = document.getElementById('coupon-banner-discount');
                const expiryElement = document.getElementById('coupon-banner-expiry');
                const textElement = document.getElementById('coupon-banner-text');
                
                console.log('Banner element:', banner);
                console.log('Code element:', codeElement);
                
                if (banner && coupon) {
                    codeElement.textContent = coupon.code;
                    discountElement.textContent = `-${coupon.discount_amount}$`;
                    
                    // Format expiry date
                    const expiryDate = new Date(coupon.expires_at);
                    expiryElement.textContent = `–¥–æ ${expiryDate.toLocaleDateString('ru-RU')}`;
                    
                    textElement.textContent = coupon.description || '–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É';
                    
                    banner.style.display = 'block';
                    console.log('Banner should now be visible');
                } else {
                    console.error('Banner or coupon not found!');
                }
            }
            
            bindEvents() {
                console.log('Binding events...');
                
                // Apply coupon from banner
                const applyBtn = document.getElementById('apply-coupon-btn');
                console.log('Apply button found:', applyBtn);
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => {
                        console.log('Apply button clicked');
                        const generalCoupons = this.availableCoupons.filter(coupon => 
                            !coupon.project_name || coupon.project_name === '–õ—é–±–æ–π'
                        );
                        if (generalCoupons.length > 0) {
                            this.applyCoupon(generalCoupons[0]);
                        }
                    });
                }
                
                // Validate coupon input
                const validateBtn = document.getElementById('validate-coupon-btn');
                const couponInput = document.getElementById('coupon-input');
                
                console.log('Validate button found:', validateBtn);
                console.log('Coupon input found:', couponInput);
                
                if (validateBtn && couponInput) {
                    validateBtn.addEventListener('click', () => {
                        console.log('Validate button clicked');
                        const code = couponInput.value.trim();
                        console.log('Code to validate:', code);
                        if (code) {
                            this.validateCoupon(code);
                        } else {
                            console.log('No code entered');
                        }
                    });
                    
                    couponInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter pressed in input');
                            const code = couponInput.value.trim();
                            if (code) {
                                this.validateCoupon(code);
                            }
                        }
                    });
                } else {
                    console.error('Required elements not found!');
                }
                
                // Double payment switch
                const doublePaymentSwitch = document.getElementById('double-payment-switch');
                console.log('Double payment switch found:', doublePaymentSwitch);
                if (doublePaymentSwitch) {
                    doublePaymentSwitch.addEventListener('change', (e) => {
                        console.log('Double payment switch changed:', e.target.checked);
                        this.handleDoublePaymentToggle(e.target.checked);
                    });
                }
                
                // Payment schedule toggle
                const toggleScheduleBtn = document.getElementById('toggle-schedule');
                const scheduleContent = document.getElementById('payment-schedule-content');
                console.log('Toggle schedule button found:', toggleScheduleBtn);
                
                if (toggleScheduleBtn && scheduleContent) {
                    toggleScheduleBtn.addEventListener('click', () => {
                        this.togglePaymentSchedule();
                    });
                    
                    // Generate payment schedule data
                    this.generatePaymentSchedule();
                }
                
                // Design variants toggle
                const variantButtons = document.querySelectorAll('.variant-btn');
                const bannerVariants = document.querySelectorAll('[id^="coupon-banner-"]');
                
                variantButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active class from all buttons
                        variantButtons.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        btn.classList.add('active');
                        
                        // Hide all banner variants
                        bannerVariants.forEach(banner => {
                            banner.style.display = 'none';
                        });
                        
                        // Show selected variant
                        const variant = btn.dataset.variant;
                        const selectedBanner = document.getElementById(`coupon-banner-${variant}`);
                        if (selectedBanner) {
                            selectedBanner.style.display = 'block';
                        }
                    });
                });
                
                // Show minimal variant by default
                const minimalBanner = document.getElementById('coupon-banner-minimal');
                if (minimalBanner) {
                    minimalBanner.style.display = 'block';
                }
            }
            
            handleDoublePaymentToggle(isEnabled) {
                console.log('Double payment toggled:', isEnabled);
                // Here you can add logic to handle double payment
                // For example, update package amount, show additional info, etc.
                if (isEnabled) {
                    console.log('Double payment enabled - bonus shares activated');
                    // Could update package summary to show bonus shares
                } else {
                    console.log('Double payment disabled - standard payment');
                }
            }
            
            async validateCoupon(code) {
                console.log('validateCoupon called with code:', code);
                const feedback = document.getElementById('coupon-feedback');
                const input = document.getElementById('coupon-input');
                
                console.log('Feedback element:', feedback);
                console.log('Input element:', input);
                
                try {
                    console.log('Making API request...');
                    const response = await fetch('/api/coupons/activate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            code: code,
                            userId: this.userId
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('API response:', result);
                    
                    if (result.success) {
                        this.showFeedback('success', `–ö—É–ø–æ–Ω "${code}" –Ω–∞–π–¥–µ–Ω! –°–∫–∏–¥–∫–∞: ${result.coupon.discount_amount}$`);
                        input.classList.remove('error');
                        input.classList.add('success');
                        
                        // Auto-apply the coupon
                        setTimeout(() => {
                            this.applyCoupon(result.coupon);
                        }, 1000);
            } else {
                        this.showFeedback('error', result.message || '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
                        input.classList.remove('success');
                        input.classList.add('error');
                    }
                } catch (error) {
                    console.error('Error validating coupon:', error);
                    this.showFeedback('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫—É–ø–æ–Ω–∞');
                    input.classList.remove('success');
                    input.classList.add('error');
                }
            }
            
            applyCoupon(coupon) {
                this.appliedCoupon = coupon;
                this.updatePackageSummary();
                this.hideCouponBanner();
                this.showAppliedCoupon();
            }
            
            showAppliedCoupon() {
                // Remove existing applied coupon display
                const existingApplied = document.querySelector('.applied-coupon');
                if (existingApplied) {
                    existingApplied.remove();
                }
                
                // Create applied coupon display
                const packageSummary = document.getElementById('package-summary');
                if (packageSummary && this.appliedCoupon) {
                    const appliedDiv = document.createElement('div');
                    appliedDiv.className = 'applied-coupon';
                    appliedDiv.innerHTML = `
                        <div class="applied-coupon-info">
                            <span class="applied-coupon-code">${this.appliedCoupon.code}</span>
                            <span class="applied-coupon-discount">–°–∫–∏–¥–∫–∞: -${this.appliedCoupon.discount_amount}$</span>
                    </div>
                        <button class="remove-coupon-btn" onclick="checkoutCoupons.removeCoupon()">–£–¥–∞–ª–∏—Ç—å</button>
                    `;
                    
                    packageSummary.appendChild(appliedDiv);
                }
            }
            
            removeCoupon() {
                this.appliedCoupon = null;
                this.updatePackageSummary();
                
                // Remove applied coupon display
                const appliedCoupon = document.querySelector('.applied-coupon');
                if (appliedCoupon) {
                    appliedCoupon.remove();
                }
                
                // Show banner again if there are available coupons
                this.checkForRelevantCoupons();
            }
            
            updatePackageAmount() {
                // Get package amount from URL or page content
                const urlParams = new URLSearchParams(window.location.search);
                const amount = urlParams.get('amount') || 500; // Default amount
                this.packageAmount = parseInt(amount);
            }
            
            updateCheckoutButton() {
                const checkoutBtn = document.getElementById('checkout-btn');
                if (!checkoutBtn) return;
                
                let discountAmount = 0;
                if (this.appliedCoupon) {
                    discountAmount = this.appliedCoupon.discount_amount;
                }
                
                const finalAmount = Math.max(0, this.packageAmount - discountAmount);
                
                console.log('Updating checkout button:');
                console.log('- User balance:', this.userBalance);
                console.log('- Package amount:', this.packageAmount);
                console.log('- Discount amount:', discountAmount);
                console.log('- Final amount:', finalAmount);
                console.log('- Has enough balance:', this.userBalance >= finalAmount);
                
                if (this.userBalance < finalAmount) {
                    // Not enough balance - show "–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç" button
                    console.log('Not enough balance - showing deposit button');
                    checkoutBtn.textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç';
                    checkoutBtn.onclick = () => {
                        window.location.href = 'deposit.html';
                    };
                    checkoutBtn.classList.add('btn--deposit');
                } else {
                    // Enough balance - show "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–∞–∫–µ—Ç" button
                    console.log('Enough balance - showing checkout button');
                    checkoutBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–∞–∫–µ—Ç';
                    checkoutBtn.onclick = () => {
                        this.processCheckout();
                    };
                    checkoutBtn.classList.remove('btn--deposit');
                }
            }
            
            processCheckout() {
                console.log('Processing checkout...');
                // Add checkout logic here
                alert('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
            }
            
            togglePaymentSchedule() {
                const scheduleContent = document.getElementById('payment-schedule-content');
                const toggleBtn = document.getElementById('toggle-schedule');
                
                if (scheduleContent && toggleBtn) {
                    const isVisible = scheduleContent.style.display !== 'none';
                    
                    if (isVisible) {
                        scheduleContent.style.display = 'none';
                        toggleBtn.classList.remove('expanded');
                    } else {
                        scheduleContent.style.display = 'block';
                        toggleBtn.classList.add('expanded');
                    }
                }
            }
            
            generatePaymentSchedule() {
                const scheduleContent = document.getElementById('payment-schedule-content');
                if (!scheduleContent) return;
                
                // Generate 10 payment entries
                const payments = [];
                const startDate = new Date('2025-10-05');
                
                for (let i = 0; i < 10; i++) {
                    const paymentDate = new Date(startDate);
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                    
                    const isBonus = i === 9; // Last payment is bonus
                    
                    payments.push({
                        number: String(i + 1).padStart(2, '0'),
                        date: paymentDate.toLocaleDateString('ru-RU'),
                        amount: '50 $',
                        type: isBonus ? '–ë–æ–Ω—É—Å–Ω—ã–π' : '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',
                        discount: isBonus ? '111' : '21',
                        shares: isBonus ? '5 550' : '1 050',
                        nominal: isBonus ? '5 550 $' : '1 050 $',
                        perShare: isBonus ? '~0,0090 $' : '~0,0476 $',
                        bonusShares: i === 0 ? '0' : '25'
                    });
                }
                
                scheduleContent.innerHTML = `
                    <!-- Desktop Table -->
                    <div class="payment-schedule-desktop">
                        <table class="payment-schedule-table">
                            <thead>
                                <tr>
                                    <th>‚Ññ</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–í–∏–¥</th>
                                    <th>–î–∏—Å–∫–æ–Ω—Ç</th>
                                    <th>–î–æ–ª–µ–π</th>
                                    <th>–ù–æ–º–∏–Ω–∞–ª</th>
                                    <th>–ó–∞ –¥–æ–ª—é</th>
                                    <th>–ë–æ–Ω—É—Å–Ω—ã–µ –¥–æ–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.map(payment => `
                                    <tr>
                                        <td class="payment-number">${payment.number}</td>
                                        <td class="payment-date">${payment.date}</td>
                                        <td class="payment-amount">${payment.amount}</td>
                                        <td>
                                            <span class="payment-type ${payment.type === '–ë–æ–Ω—É—Å–Ω—ã–π' ? 'bonus' : 'standard'}">
                                                ${payment.type}
                                            </span>
                                        </td>
                                        <td class="payment-discount">${payment.discount}</td>
                                        <td class="payment-shares">${payment.shares}</td>
                                        <td class="payment-nominal">${payment.nominal}</td>
                                        <td class="payment-per-share">${payment.perShare}</td>
                                        <td>
                                            <span class="bonus-shares-badge">${payment.bonusShares}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Cards -->
                    <div class="payment-schedule-mobile">
                        ${payments.map(payment => `
                            <div class="payment-card-mobile">
                                <div class="payment-card-header">
                                    <div class="payment-number-mobile">${payment.number}</div>
                                    <div class="payment-type-mobile ${payment.type === '–ë–æ–Ω—É—Å–Ω—ã–π' ? 'bonus' : 'standard'}">
                                        ${payment.type}
                                    </div>
                                </div>
                                <div class="payment-card-content">
                                    <div class="payment-info-row">
                                        <span class="info-label">–î–∞—Ç–∞:</span>
                                        <span class="info-value">${payment.date}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–°—É–º–º–∞:</span>
                                        <span class="info-value payment-amount">${payment.amount}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–î–∏—Å–∫–æ–Ω—Ç:</span>
                                        <span class="info-value payment-discount">${payment.discount}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–î–æ–ª–µ–π:</span>
                                        <span class="info-value payment-shares">${payment.shares}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–ù–æ–º–∏–Ω–∞–ª:</span>
                                        <span class="info-value payment-nominal">${payment.nominal}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–ó–∞ –¥–æ–ª—é:</span>
                                        <span class="info-value payment-per-share">${payment.perShare}</span>
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="info-label">–ë–æ–Ω—É—Å–Ω—ã–µ –¥–æ–ª–∏:</span>
                                        <span class="info-value">
                                            <span class="bonus-shares-badge">${payment.bonusShares}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            updatePackageSummary() {
                const summary = document.getElementById('package-summary');
                const mobileSummary = document.getElementById('mobile-package-summary');
                
                let discountAmount = 0;
                if (this.appliedCoupon) {
                    discountAmount = this.appliedCoupon.discount_amount;
                }
                
                const finalAmount = Math.max(0, this.packageAmount - discountAmount);
                
                const summaryHTML = `
                    <div class="package-summary-item">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞–∫–µ—Ç–∞:</span>
                        <span>$${this.packageAmount}</span>
                    </div>
                    ${discountAmount > 0 ? `
                        <div class="package-summary-item discount">
                            <span>–°–∫–∏–¥–∫–∞ –ø–æ –∫—É–ø–æ–Ω—É:</span>
                            <span>-$${discountAmount}</span>
                        </div>
                    ` : ''}
                    <div class="package-summary-item total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                        <span>$${finalAmount}</span>
                    </div>
                `;
                
                if (summary) {
                    summary.innerHTML = summaryHTML;
                }
                
                if (mobileSummary) {
                    mobileSummary.innerHTML = `
                        <div class="mobile-summary-item">
                            <span>–ù–æ–º–∏–Ω–∞–ª:</span>
                            <span>15 000 $</span>
                        </div>
                        ${discountAmount > 0 ? `
                            <div class="mobile-summary-item discount">
                                <span>–°–∫–∏–¥–∫–∞:</span>
                                <span>-$${discountAmount}</span>
                            </div>
                        ` : ''}
                        <div class="mobile-summary-item total">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>$${finalAmount}</span>
                        </div>
                    `;
                }
                
                // Update checkout button based on new amount
                this.updateCheckoutButton();
            }
            
            showFeedback(type, message) {
                console.log('showFeedback called:', type, message);
                const feedback = document.getElementById('coupon-feedback');
                console.log('Feedback element:', feedback);
                if (feedback) {
                    feedback.textContent = message;
                    feedback.className = `coupon-feedback ${type}`;
                    console.log('Feedback updated');
                } else {
                    console.error('Feedback element not found!');
                }
            }
            
            hideCouponBanner() {
                const banner = document.getElementById('coupon-banner');
                if (banner) {
                    banner.style.display = 'none';
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing CheckoutCoupons');
            window.checkoutCoupons = new CheckoutCoupons();
            console.log('CheckoutCoupons initialized:', window.checkoutCoupons);
        });
    </script>
</body>
</html>