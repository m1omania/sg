<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ - SolarGroup</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
            <!-- Web Component Header -->
    <sg-header></sg-header>

    <div class="app-layout">
                        <!-- Web Component Sidebar -->
        <sg-sidebar></sg-sidebar>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 id="package-title">–ü–∞–∫–µ—Ç 500 $</h1>
                <div class="package-stage-badge" id="package-stage">20 —ç—Ç–∞–ø            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>

            <div class="checkout-container">
                <div class="checkout-main">
                    <!-- Package Details -->
                    <div class="package-details-card">
                        <h3>–î–µ—Ç–∞–ª–∏ –ø–∞–∫–µ—Ç–∞</h3>
                        <div class="package-summary" id="package-summary">
                            <!-- Package details will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Coupon Section -->
                    <div class="coupon-section-card">
                        <!-- Coupon Banner -->
                        <div class="coupon-banner" id="coupon-banner" style="display: none;">
                            <div class="coupon-banner-content">
                                <div class="coupon-banner-icon">üéüÔ∏è</div>
                                <div class="coupon-banner-info">
                                    <h4>–ï—Å—Ç—å –∫—É–ø–æ–Ω!</h4>
                                    <p id="coupon-banner-text">–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É</p>
                                    <div class="coupon-banner-details">
                                        <span class="coupon-code" id="coupon-banner-code">WELCOME25</span>
                                        <span class="coupon-discount" id="coupon-banner-discount">-25$</span>
                                        <span class="coupon-expiry" id="coupon-banner-expiry">–¥–æ 31.12.2025</span>
                                    </div>
                                </div>
                                <button class="btn btn--primary btn--small" id="apply-coupon-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                        
                        <!-- Coupon Input -->
                        <div class="coupon-input-section">
                            <label for="coupon-input" class="coupon-label">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –∫—É–ø–æ–Ω</label>
                            <div class="coupon-input-container">
                                <input type="text" id="coupon-input" class="coupon-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫—É–ø–æ–Ω–∞">
                                <button class="btn btn--secondary" id="validate-coupon-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                            </div>
                            <div class="coupon-feedback" id="coupon-feedback"></div>
                        </div>
                    </div>

                    <!-- Payment Schedule -->
                    <div class="payment-schedule-card" id="payment-schedule-card" style="display: none;">
                        <div class="card-header">
                            <h3>–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                            <button class="btn btn--secondary btn--small" id="toggle-schedule">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                        <div class="payment-schedule-content" id="payment-schedule-content">
                            <!-- Payment schedule will be generated here -->
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                    </div>

                    <!-- Bonus Banner -->
                    <div class="bonus-banner" id="bonus-banner" style="display: none;">
                        <div class="bonus-icon">üéÅ            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                        <div class="bonus-content">
                            <h4>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–π –±–æ–Ω—É—Å</h4>
                            <div class="bonus-details">
                                <span class="bonus-amount" id="bonus-amount">750 –¥–æ–ª–µ–π</span>
                                <span class="bonus-percentage" id="bonus-percentage">+5%</span>
                                <a href="#" class="bonus-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                            </div>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                    </div>
                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                </div>

                <div class="checkout-sidebar">
                    <!-- Payment Options -->
                    <div class="payment-card">
                        <h3>–û–ø–ª–∞—Ç–∞ –ø–∞–∫–µ—Ç–∞</h3>
                        
                        <div class="account-selector">
                            <h4>–í—ã–±–µ—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç</h4>
                            <div class="account-options">
                                <div class="account-option selected" data-account="main">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="main" checked>
                                        <span class="radio-custom"></span>
                                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–û—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                        <div class="account-balance main-balance-amount">–ë–∞–ª–∞–Ω—Å 0,00 $            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                    </div>
                                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                </div>
                                
                                <div class="account-option" data-account="partner">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="partner">
                                        <span class="radio-custom"></span>
                                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π —Å—á—ë—Ç            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                        <div class="account-balance partner-balance-amount">–ë–∞–ª–∞–Ω—Å 0,00 $            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                        <div class="account-bonus">+5%            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                    </div>
                                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                                </div>
                                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                            </div>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>

                        <div class="payment-options">
                            <div class="payment-option">
                                <input type="radio" name="payment-type" value="double" id="double-payment">
                                <label for="double-payment">
                                    <div class="payment-icon">üí∞            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                    <div class="payment-text">–î–≤–æ–π–Ω–æ–π –ø–ª–∞—Ç–µ–∂            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                                </label>
                                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                            </div>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>

                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary-card">
                        <div class="summary-row">
                            <span>–ü–∞–∫–µ—Ç</span>
                            <span id="summary-package">500 $</span>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                        <div class="summary-row">
                            <span>–≠—Ç–∞–ø</span>
                            <span id="summary-stage">20</span>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                        <div class="summary-row">
                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–µ–π –≤ –ø–∞–∫–µ—Ç–µ</span>
                            <span id="summary-shares">15 000</span>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                        <div class="summary-row">
                            <span>–ü—Ä–æ–µ–∫—Ç</span>
                            <span id="summary-project">–°–æ–≤—ç–ª–º–∞—à</span>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>
                        
                        <div class="summary-divider">            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
        </div>
                        
                        <div class="summary-row total">
                            <strong>–ò—Ç–æ–≥–æ</strong>
                            <strong id="summary-total">50,00 $</strong>
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>

                        <div class="insufficient-funds-warning" id="insufficient-funds" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–∞–∫–µ—Ç–∞
                                    <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                        </div>

                        <button class="btn btn--primary btn--full" id="checkout-btn">
                            –ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç
                        </button>
                                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                    </div>
                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>

            <!-- Success Notification -->
            <div class="notification hidden" id="success-notification">
                <div class="notification-content">
                    <span id="notification-text">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</span>
                    <button class="notification-close">&times;</button>
                            <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
                </div>
                        <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
            </div>
        </main>
                <span class="logo logo-fallback" style="display: none;">SolarGroup</span>
    </div>

        
            <script src="components/web-components/header-standalone.js"></script>
    <script src="components/web-components/sidebar-standalone.js"></script>
    <script src="app.js"></script>
    
    <script src="checkout.js"></script>
    <script>
        // Checkout Coupons Logic
        console.log('Checkout coupons script loaded');

        class CheckoutCoupons {
            constructor() {
                console.log('CheckoutCoupons constructor called');
                this.userId = 1; // Demo user ID
                this.availableCoupons = [];
                this.appliedCoupon = null;
                this.packageAmount = 0;
                
                this.init();
            }
            
            init() {
                this.loadAvailableCoupons();
                this.bindEvents();
                this.updatePackageAmount();
            }
            
            async loadAvailableCoupons() {
                try {
                    const response = await fetch(`/api/coupons/active/${this.userId}`);
                    const coupons = await response.json();
                    
                    this.availableCoupons = coupons;
                    this.checkForRelevantCoupons();
                } catch (error) {
                    console.error('Error loading coupons:', error);
                }
            }
            
            checkForRelevantCoupons() {
                console.log('Checking for relevant coupons...');
                console.log('Available coupons:', this.availableCoupons);
                
                // Check for general coupons (not tied to specific projects)
                const generalCoupons = this.availableCoupons.filter(coupon => 
                    !coupon.project_name || coupon.project_name === '–õ—é–±–æ–π'
                );
                
                console.log('General coupons found:', generalCoupons);
                
                if (generalCoupons.length > 0) {
                    this.showCouponBanner(generalCoupons[0]);
                } else {
                    console.log('No general coupons found');
                }
            }
            
            showCouponBanner(coupon) {
                console.log('showCouponBanner called with coupon:', coupon);
                const banner = document.getElementById('coupon-banner');
                const codeElement = document.getElementById('coupon-banner-code');
                const discountElement = document.getElementById('coupon-banner-discount');
                const expiryElement = document.getElementById('coupon-banner-expiry');
                const textElement = document.getElementById('coupon-banner-text');
                
                console.log('Banner element:', banner);
                console.log('Code element:', codeElement);
                
                if (banner && coupon) {
                    codeElement.textContent = coupon.code;
                    discountElement.textContent = `-${coupon.discount_amount}$`;
                    
                    // Format expiry date
                    const expiryDate = new Date(coupon.expires_at);
                    expiryElement.textContent = `–¥–æ ${expiryDate.toLocaleDateString('ru-RU')}`;
                    
                    textElement.textContent = coupon.description || '–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—É–ø–æ–Ω –Ω–∞ —Å–∫–∏–¥–∫—É';
                    
                    banner.style.display = 'block';
                    console.log('Banner should now be visible');
                } else {
                    console.error('Banner or coupon not found!');
                }
            }
            
            bindEvents() {
                console.log('Binding events...');
                
                // Apply coupon from banner
                const applyBtn = document.getElementById('apply-coupon-btn');
                console.log('Apply button found:', applyBtn);
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => {
                        console.log('Apply button clicked');
                        const generalCoupons = this.availableCoupons.filter(coupon => 
                            !coupon.project_name || coupon.project_name === '–õ—é–±–æ–π'
                        );
                        if (generalCoupons.length > 0) {
                            this.applyCoupon(generalCoupons[0]);
                        }
                    });
                }
                
                // Validate coupon input
                const validateBtn = document.getElementById('validate-coupon-btn');
                const couponInput = document.getElementById('coupon-input');
                
                console.log('Validate button found:', validateBtn);
                console.log('Coupon input found:', couponInput);
                
                if (validateBtn && couponInput) {
                    validateBtn.addEventListener('click', () => {
                        console.log('Validate button clicked');
                        const code = couponInput.value.trim();
                        console.log('Code to validate:', code);
                        if (code) {
                            this.validateCoupon(code);
                        } else {
                            console.log('No code entered');
                        }
                    });
                    
                    couponInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter pressed in input');
                            const code = couponInput.value.trim();
                            if (code) {
                                this.validateCoupon(code);
                            }
                        }
                    });
                } else {
                    console.error('Required elements not found!');
                }
            }
            
            async validateCoupon(code) {
                console.log('validateCoupon called with code:', code);
                const feedback = document.getElementById('coupon-feedback');
                const input = document.getElementById('coupon-input');
                
                console.log('Feedback element:', feedback);
                console.log('Input element:', input);
                
                try {
                    console.log('Making API request...');
                    const response = await fetch('/api/coupons/activate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            code: code,
                            userId: this.userId
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('API response:', result);
                    
                    if (result.success) {
                        this.showFeedback('success', `–ö—É–ø–æ–Ω "${code}" –Ω–∞–π–¥–µ–Ω! –°–∫–∏–¥–∫–∞: ${result.coupon.discount_amount}$`);
                        input.classList.remove('error');
                        input.classList.add('success');
                        
                        // Auto-apply the coupon
                        setTimeout(() => {
                            this.applyCoupon(result.coupon);
                        }, 1000);
                    } else {
                        this.showFeedback('error', result.message || '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
                        input.classList.remove('success');
                        input.classList.add('error');
                    }
                } catch (error) {
                    console.error('Error validating coupon:', error);
                    this.showFeedback('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫—É–ø–æ–Ω–∞');
                    input.classList.remove('success');
                    input.classList.add('error');
                }
            }
            
            applyCoupon(coupon) {
                this.appliedCoupon = coupon;
                this.updatePackageSummary();
                this.hideCouponBanner();
                this.showAppliedCoupon();
            }
            
            showAppliedCoupon() {
                // Remove existing applied coupon display
                const existingApplied = document.querySelector('.applied-coupon');
                if (existingApplied) {
                    existingApplied.remove();
                }
                
                // Create applied coupon display
                const packageSummary = document.getElementById('package-summary');
                if (packageSummary && this.appliedCoupon) {
                    const appliedDiv = document.createElement('div');
                    appliedDiv.className = 'applied-coupon';
                    appliedDiv.innerHTML = `
                        <div class="applied-coupon-info">
                            <span class="applied-coupon-code">${this.appliedCoupon.code}</span>
                            <span class="applied-coupon-discount">–°–∫–∏–¥–∫–∞: -${this.appliedCoupon.discount_amount}$</span>
                        </div>
                        <button class="remove-coupon-btn" onclick="checkoutCoupons.removeCoupon()">–£–¥–∞–ª–∏—Ç—å</button>
                    `;
                    
                    packageSummary.appendChild(appliedDiv);
                }
            }
            
            removeCoupon() {
                this.appliedCoupon = null;
                this.updatePackageSummary();
                
                // Remove applied coupon display
                const appliedCoupon = document.querySelector('.applied-coupon');
                if (appliedCoupon) {
                    appliedCoupon.remove();
                }
                
                // Show banner again if there are available coupons
                this.checkForRelevantCoupons();
            }
            
            updatePackageAmount() {
                // Get package amount from URL or page content
                const urlParams = new URLSearchParams(window.location.search);
                const amount = urlParams.get('amount') || 500; // Default amount
                this.packageAmount = parseInt(amount);
            }
            
            updatePackageSummary() {
                const summary = document.getElementById('package-summary');
                if (!summary) return;
                
                let discountAmount = 0;
                if (this.appliedCoupon) {
                    discountAmount = this.appliedCoupon.discount_amount;
                }
                
                const finalAmount = Math.max(0, this.packageAmount - discountAmount);
                
                summary.innerHTML = `
                    <div class="package-summary-item">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞–∫–µ—Ç–∞:</span>
                        <span>$${this.packageAmount}</span>
                    </div>
                    ${discountAmount > 0 ? `
                        <div class="package-summary-item discount">
                            <span>–°–∫–∏–¥–∫–∞ –ø–æ –∫—É–ø–æ–Ω—É:</span>
                            <span>-$${discountAmount}</span>
                        </div>
                    ` : ''}
                    <div class="package-summary-item total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                        <span>$${finalAmount}</span>
                    </div>
                `;
            }
            
            showFeedback(type, message) {
                console.log('showFeedback called:', type, message);
                const feedback = document.getElementById('coupon-feedback');
                console.log('Feedback element:', feedback);
                if (feedback) {
                    feedback.textContent = message;
                    feedback.className = `coupon-feedback ${type}`;
                    console.log('Feedback updated');
                } else {
                    console.error('Feedback element not found!');
                }
            }
            
            hideCouponBanner() {
                const banner = document.getElementById('coupon-banner');
                if (banner) {
                    banner.style.display = 'none';
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing CheckoutCoupons');
            window.checkoutCoupons = new CheckoutCoupons();
            console.log('CheckoutCoupons initialized:', window.checkoutCoupons);
        });
    </script>
</body>
</html>