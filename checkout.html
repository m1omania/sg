<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ - SolarGroup</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header__logo">
            <span class="logo">SolarGroup</span>
        </div>
        <div class="header__controls">
            <div class="language-switcher">
                <button class="lang-btn active" data-lang="ru">RU</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            <button class="notification-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span class="notification-count">2</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <div class="user-profile">
                    <div class="user-avatar">–ö</div>
                    <span class="user-name">–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω</span>
                    <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-menu-item">
                        <span class="dropdown-menu-item-icon">üë§</span>
                        –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                    <a href="#" class="dropdown-menu-item">
                        <span class="dropdown-menu-item-icon">‚öôÔ∏è</span>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </a>
                    <a href="#" class="dropdown-menu-item">
                        <span class="dropdown-menu-item-icon">üìÑ</span>
                        –î–æ–∫—É–º–µ–Ω—Ç—ã
                    </a>
                    <div class="dropdown-menu-divider"></div>
                    <a href="#" class="dropdown-menu-item" id="logoutBtn">
                        <span class="dropdown-menu-item-icon">üö™</span>
                        –í—ã–π—Ç–∏
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="nav-item"><a href="wallet.html" class="nav-link">–ö–æ—à–µ–ª—ë–∫</a></li>
                <li class="nav-item"><a href="invest.html" class="nav-link">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
                <li class="nav-item"><a href="coupons.html" class="nav-link">–ö—É–ø–æ–Ω—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 id="package-title">–ü–∞–∫–µ—Ç 500 $</h1>
                <div class="package-stage-badge" id="package-stage">20 —ç—Ç–∞–ø</div>
            </div>

            <div class="checkout-container">
                <div class="checkout-main">
                    <!-- Package Details -->
                    <div class="package-details-card">
                        <h3>–î–µ—Ç–∞–ª–∏ –ø–∞–∫–µ—Ç–∞</h3>
                        <div class="package-summary" id="package-summary">
                            <!-- Package details will be loaded here -->
                        </div>
                    </div>

                    <!-- Payment Schedule -->
                    <div class="payment-schedule-card" id="payment-schedule-card" style="display: none;">
                        <div class="card-header">
                            <h3>–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                            <button class="btn btn--secondary btn--small" id="toggle-schedule">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                        <div class="payment-schedule-content" id="payment-schedule-content">
                            <!-- Payment schedule will be generated here -->
                        </div>
                    </div>

                    <!-- Bonus Banner -->
                    <div class="bonus-banner" id="bonus-banner" style="display: none;">
                        <div class="bonus-icon">üéÅ</div>
                        <div class="bonus-content">
                            <h4>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–π –±–æ–Ω—É—Å</h4>
                            <div class="bonus-details">
                                <span class="bonus-amount" id="bonus-amount">750 –¥–æ–ª–µ–π</span>
                                <span class="bonus-percentage" id="bonus-percentage">+5%</span>
                                <a href="#" class="bonus-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkout-sidebar">
                    <!-- Payment Options -->
                    <div class="payment-card">
                        <h3>–û–ø–ª–∞—Ç–∞ –ø–∞–∫–µ—Ç–∞</h3>
                        
                        <div class="account-selector">
                            <h4>–í—ã–±–µ—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç</h4>
                            <div class="account-options">
                                <div class="account-option selected" data-account="main">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="main" checked>
                                        <span class="radio-custom"></span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–û—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç</div>
                                        <div class="account-balance" id="main-balance">–ë–∞–ª–∞–Ω—Å 0,00 $</div>
                                    </div>
                                </div>
                                
                                <div class="account-option" data-account="partner">
                                    <div class="account-radio">
                                        <input type="radio" name="account" value="partner">
                                        <span class="radio-custom"></span>
                                    </div>
                                    <div class="account-info">
                                        <div class="account-name">–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π —Å—á—ë—Ç</div>
                                        <div class="account-balance" id="partner-balance">–ë–∞–ª–∞–Ω—Å 0,00 $</div>
                                        <div class="account-bonus">+5%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="payment-options">
                            <div class="payment-option">
                                <input type="radio" name="payment-type" value="double" id="double-payment">
                                <label for="double-payment">
                                    <div class="payment-icon">üí∞</div>
                                    <div class="payment-text">–î–≤–æ–π–Ω–æ–π –ø–ª–∞—Ç–µ–∂</div>
                                </label>
                            </div>
                        </div>

                        <div class="promo-section">
                            <button class="btn btn--secondary btn--full promo-btn" id="promo-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3l8-8"></path>
                                    <path d="M21 12c0 1.66-1.34 3-3 3h-3l-2-3h-2l-2 3H8c-1.66 0-3-1.34-3-3s1.34-3 3-3h3l2 3h2l2-3h3c1.66 0 3 1.34 3 3z"></path>
                                </svg>
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                            </button>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary-card">
                        <div class="summary-row">
                            <span>–ü–∞–∫–µ—Ç</span>
                            <span id="summary-package">500 $</span>
                        </div>
                        <div class="summary-row">
                            <span>–≠—Ç–∞–ø</span>
                            <span id="summary-stage">20</span>
                        </div>
                        <div class="summary-row">
                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–µ–π –≤ –ø–∞–∫–µ—Ç–µ</span>
                            <span id="summary-shares">15 000</span>
                        </div>
                        <div class="summary-row">
                            <span>–ü—Ä–æ–µ–∫—Ç</span>
                            <span id="summary-project">–°–æ–≤—ç–ª–º–∞—à</span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-row total">
                            <strong>–ò—Ç–æ–≥–æ</strong>
                            <strong id="summary-total">50,00 $</strong>
                        </div>

                        <div class="insufficient-funds-warning" id="insufficient-funds" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–∞–∫–µ—Ç–∞
                        </div>

                        <button class="btn btn--primary btn--full" id="checkout-btn">
                            –ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç
                        </button>
                    </div>
                </div>
            </div>

            <!-- Success Notification -->
            <div class="notification hidden" id="success-notification">
                <div class="notification-content">
                    <span id="notification-text">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</span>
                    <button class="notification-close">&times;</button>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const packageId = urlParams.get('package') || 'sov-500';
            
            initializeCheckoutPage(packageId);
            setupEventListeners();
        });

        function initializeCheckoutPage(packageId) {
            // Sample package data - in real app this would come from API
            const packagesData = {
                'sov-500': {
                    title: '–ü–∞–∫–µ—Ç 500 $',
                    stage: 20,
                    project: '–°–æ–≤—ç–ª–º–∞—à',
                    amount: 500,
                    shares: 15000,
                    bonusShares: 0,
                    pricePerShare: 0.03333,
                    discount: 30,
                    installment: '10 –º–µ—Å.',
                    nominal: '15 000 $',
                    payment: 50
                },
                'sov-500-bonus': {
                    title: '–ü–∞–∫–µ—Ç 500 $',
                    stage: 20,
                    project: '–°–æ–≤—ç–ª–º–∞—à', 
                    amount: 500,
                    shares: 15500,
                    bonusShares: 500,
                    pricePerShare: 0.03226,
                    discount: 31,
                    installment: null,
                    nominal: '15 500 $',
                    payment: 500
                }
            };

            const packageData = packagesData[packageId] || packagesData['sov-500'];
            
            // Update page content
            document.getElementById('package-title').textContent = packageData.title;
            document.getElementById('package-stage').textContent = `${packageData.stage} —ç—Ç–∞–ø`;
            
            renderPackageDetails(packageData);
            renderOrderSummary(packageData);
            loadUserBalance();
            
            if (packageData.installment) {
                generatePaymentSchedule(packageData);
            }
            
            if (packageData.bonusShares > 0) {
                showBonusBanner(packageData.bonusShares);
            }
        }

        function renderPackageDetails(pkg) {
            const container = document.getElementById('package-summary');
            container.innerHTML = `
                <div class="package-detail-row">
                    <span class="detail-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–µ–π</span>
                    <span class="detail-value">${pkg.shares.toLocaleString()}</span>
                </div>
                ${pkg.bonusShares > 0 ? `
                    <div class="package-detail-row bonus">
                        <span class="detail-label">–ë–æ–Ω—É—Å–Ω—ã–µ –¥–æ–ª–∏</span>
                        <span class="detail-value">+${pkg.bonusShares}</span>
                    </div>
                ` : ''}
                <div class="package-detail-row">
                    <span class="detail-label">–¶–µ–Ω–∞ –∑–∞ –¥–æ–ª—é</span>
                    <span class="detail-value">~${pkg.pricePerShare} $</span>
                </div>
                <div class="package-detail-row">
                    <span class="detail-label">–î–∏—Å–∫–æ–Ω—Ç</span>
                    <span class="detail-value">-${pkg.discount}</span>
                </div>
                ${pkg.installment ? `
                    <div class="package-detail-row">
                        <span class="detail-label">–†–∞—Å—Å—Ä–æ—á–∫–∞</span>
                        <span class="detail-value">${pkg.installment}</span>
                    </div>
                ` : ''}
                <div class="package-detail-row">
                    <span class="detail-label">–ù–æ–º–∏–Ω–∞–ª</span>
                    <span class="detail-value">${pkg.nominal}</span>
                </div>
            `;
        }

        function renderOrderSummary(pkg) {
            document.getElementById('summary-package').textContent = `${pkg.amount} $`;
            document.getElementById('summary-stage').textContent = pkg.stage;
            document.getElementById('summary-shares').textContent = pkg.shares.toLocaleString();
            document.getElementById('summary-project').textContent = pkg.project;
            document.getElementById('summary-total').textContent = `${pkg.payment.toFixed(2)} $`;
        }

        async function loadUserBalance() {
            try {
                const response = await fetch('/api/wallet/1');
                if (response.ok) {
                    const wallet = await response.json();
                    document.getElementById('main-balance').textContent = `–ë–∞–ª–∞–Ω—Å ${Number(wallet.main_balance).toFixed(2)} $`;
                    document.getElementById('partner-balance').textContent = `–ë–∞–ª–∞–Ω—Å ${Number(wallet.bonus_balance || 0).toFixed(2)} $`;
                    
                    checkSufficientFunds(wallet);
                }
            } catch (error) {
                console.error('Error loading wallet:', error);
            }
        }

        function checkSufficientFunds(wallet) {
            const totalAmount = parseFloat(document.getElementById('summary-total').textContent);
            const mainBalance = wallet.main_balance;
            const partnerBalance = wallet.bonus_balance || 0;
            
            const selectedAccount = document.querySelector('input[name="account"]:checked').value;
            const availableBalance = selectedAccount === 'main' ? mainBalance : partnerBalance;
            
            const insufficientFunds = document.getElementById('insufficient-funds');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (availableBalance < totalAmount) {
                insufficientFunds.style.display = 'flex';
                checkoutBtn.textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç';
                checkoutBtn.onclick = () => window.location.href = 'deposit.html';
            } else {
                insufficientFunds.style.display = 'none';
                checkoutBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–∞–∫–µ—Ç';
                checkoutBtn.onclick = processCheckout;
            }
        }

        function generatePaymentSchedule(pkg) {
            const scheduleCard = document.getElementById('payment-schedule-card');
            const scheduleContent = document.getElementById('payment-schedule-content');
            
            scheduleCard.style.display = 'block';
            
            // Generate 10 monthly payments
            let schedule = '';
            for (let i = 1; i <= 10; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() + i);
                
                schedule += `
                    <div class="payment-row">
                        <span>${date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}</span>
                        <span>${pkg.payment.toFixed(2)} $</span>
                    </div>
                `;
            }
            
            scheduleContent.innerHTML = schedule;
        }

        function showBonusBanner(bonusShares) {
            const banner = document.getElementById('bonus-banner');
            const bonusAmount = document.getElementById('bonus-amount');
            const bonusPercentage = document.getElementById('bonus-percentage');
            
            banner.style.display = 'flex';
            bonusAmount.textContent = `${bonusShares} –¥–æ–ª–µ–π`;
            bonusPercentage.textContent = '+5%';
        }

        function setupEventListeners() {
            // Account selection
            document.querySelectorAll('.account-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.account-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    
                    // Recheck sufficient funds
                    loadUserBalance();
                });
            });

            // Toggle payment schedule
            const toggleBtn = document.getElementById('toggle-schedule');
            const scheduleContent = document.getElementById('payment-schedule-content');
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const isVisible = scheduleContent.style.display !== 'none';
                    scheduleContent.style.display = isVisible ? 'none' : 'block';
                    this.querySelector('svg').style.transform = isVisible ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            // Promo code button
            document.getElementById('promo-btn').addEventListener('click', function() {
                window.location.href = 'coupons.html';
            });
        }

        async function processCheckout() {
            const packageAmount = parseFloat(document.getElementById('summary-total').textContent);
            const selectedAccount = document.querySelector('input[name="account"]:checked').value;
            
            try {
                const response = await fetch('/api/investments/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 1,
                        projectId: 'sovelmash',
                        amount: packageAmount,
                        accountType: selectedAccount
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('–ü–∞–∫–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω!');
                    setTimeout(() => {
                        window.location.href = 'my-investments.html';
                    }, 2000);
                } else {
                    showNotification(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–∞–∫–µ—Ç–∞');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('success-notification');
            const messageElement = document.getElementById('notification-text');
            
            messageElement.textContent = message;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
